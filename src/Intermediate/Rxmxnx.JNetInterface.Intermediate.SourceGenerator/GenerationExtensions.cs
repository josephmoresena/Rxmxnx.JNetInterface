using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Text;

using Microsoft.CodeAnalysis;

namespace Rxmxnx.JNetInterface.SourceGenerator
{
    internal static class GenerationExtensions
    {
        public static INamedTypeSymbol[] GetSourceTypeSymbols(this GeneratorExecutionContext context)
        {
            List<INamedTypeSymbol> result = new List<INamedTypeSymbol>();
            AppendTypeSymbols(context.Compilation.SourceModule.GlobalNamespace, result);
            return result.ToArray();
        }
        public static String GetLiteralValue(this ISymbol symbol)
        {
            if (symbol.CanBeReferencedByName)
            {
                AttributeData attribute = symbol.GetAttributes()
                    .FirstOrDefault(a => a.AttributeClass.Name == nameof(DefaultValueAttribute));
                TypedConstant? paramsAttr = (attribute?.ConstructorArguments)?.FirstOrDefault();
                return paramsAttr?.Value as String;
            }

            return default;
        }
        public static String GetOrdinalSuffix(this Int32 numbert)
        {
            String textNumber = numbert.ToString();
            if (textNumber.EndsWith("11")) return "th";
            if (textNumber.EndsWith("12")) return "th";
            if (textNumber.EndsWith("13")) return "th";
            if (textNumber.EndsWith("1")) return "st";
            if (textNumber.EndsWith("2")) return "nd";
            if (textNumber.EndsWith("3")) return "rd";
            return "th";
        }

        public static void GenerateUnicodeConstructor(this GeneratorExecutionContext context, String fullyQualifiedClassName)
        {
            INamedTypeSymbol tClass = context.Compilation.GetTypeByMetadataName(fullyQualifiedClassName);
            if (tClass != null)
            {
                StringBuilder strBuild = new StringBuilder();
                foreach (ISymbol symbol in tClass.GetMembers())
                    if (symbol.GetLiteralValue() is String value)
                        strBuild.AppendLine($"\t\t{symbol.Name} = new(() => \"{value}\"u8);");
                context.AddSource($"{tClass.Name}.g.cs", GetGeneratedUnicode(tClass, strBuild));
            }
        }

        private static String GetGeneratedUnicode(INamedTypeSymbol tClass, StringBuilder strBuild)
            => $@"// <auto-generated/>
namespace {tClass.ContainingNamespace};

partial class {tClass.Name} 
{{
	/// <summary>
	/// Static constructor.
	/// </summary>
	static {tClass.Name}()
	{{
{strBuild}	}}
}}";
        private static void AppendTypeSymbols(INamespaceSymbol namespaceSymbol, IList<INamedTypeSymbol> list)
        {
            foreach (INamespaceOrTypeSymbol symbol in namespaceSymbol.GetMembers())
                if (symbol.IsType)
                    list.Add((INamedTypeSymbol)symbol);
                else
                    AppendTypeSymbols((INamespaceSymbol)symbol, list);
        }
    }
}
